## **SALON BOARDスタイル自動投稿Webアプリケーション 実装計画書**

### **1. プロジェクト概要**

#### **1.1. 目的**
要件定義書と詳細設計書に基づき、SALON BOARDスタイル自動投稿Webアプリケーションの完全実装を行う。

#### **1.2. 技術スタック**
- **バックエンド**: Python 3.11+, FastAPI, Uvicorn
- **データベース**: PostgreSQL 15+
- **タスクキュー**: Celery, Redis
- **ブラウザ自動化**: Playwright for Python
- **フロントエンド**: Jinja2, HTML5, CSS3, JavaScript
- **コンテナ**: Docker, Docker Compose
- **認証**: JWT (python-jose)
- **セキュリティ**: passlib[bcrypt], cryptography (Fernet)

#### **1.3. アーキテクチャ**
- Nginxコンテナ（リバースプロキシ、SSL終端、静的ファイル配信）
- Webコンテナ（FastAPI）
- Workerコンテナ（Celery + Playwright）
  - **重要**: ARM64環境でのFirefox起動問題を回避するため、`platform: linux/amd64`を指定
- PostgreSQLコンテナ
- Redisコンテナ

#### **1.4. 実装済み重要修正**
- **ARM64互換性**: Docker設定に`platform: linux/amd64`を追加
- **画像アップロード**: `.isActive`クラス待機を削除し、2秒待機+直接クリック方式に変更
- **タスク中止機能**: 強制終了機能を実装（SIGKILL送信）
- **進捗コールバック**: try-exceptブロックの外に配置してキャンセル可能に

---

### **2. 実装タスク一覧**

---

## **フェーズ1: プロジェクト基盤構築**
**優先度: 最高 | 期間: 1-2日**

### **ステップ1.1: プロジェクト構造のセットアップ**

- [x] ディレクトリ構造作成

### **ステップ1.2: 依存関係定義**

- [x] `requirements.txt`作成

### **ステップ1.3: 環境設定ファイル**

- [x] `.env.example`作成
- [x] `.gitignore`作成

### **ステップ1.4: Docker環境構築**

- [x] `Dockerfile`作成
- [x] `docker-compose.yml`作成
- [x] Nginx設定ファイル作成

---

## **フェーズ2: コア機能実装**
**優先度: 最高 | 期間: 2-3日**

### **ステップ2.1: データベース層**

- [x] `app/db/session.py`実装
- [x] `app/models/user.py`実装
- [x] `app/models/salon_board_setting.py`実装
- [x] `app/models/current_task.py`実装

### **ステップ2.2: セキュリティ層**

- [x] `app/core/config.py`実装
- [x] `app/core/security.py`実装

### **ステップ2.3: スキーマ層**

- [x] `app/schemas/token.py`実装
- [x] `app/schemas/user.py`実装
- [x] `app/schemas/salon_board_setting.py`実装
- [x] `app/schemas/task.py`実装

### **ステップ2.4: CRUD層**

- [x] `app/crud/user.py`実装
- [x] `app/crud/salon_board_setting.py`実装
- [x] `app/crud/current_task.py`実装

---

## **フェーズ3: API実装**
**優先度: 最高 | 期間: 2-3日**

### **ステップ3.1: 認証エンドポイント**

- [x] `app/api/v1/endpoints/auth.py`実装

### **ステップ3.2: ユーザー管理エンドポイント（管理者専用）**

- [x] `app/api/v1/endpoints/users.py`実装

### **ステップ3.3: SALON BOARD設定エンドポイント**

- [x] `app/api/v1/endpoints/sb_settings.py`実装

### **ステップ3.4: タスク管理エンドポイント**

- [x] `app/api/v1/endpoints/tasks.py`実装
  - [x] ファイルバリデーション関数実装

### **ステップ3.5: APIルーター統合**

- [x] `app/api/v1/api.py`実装
- [x] `app/main.py`実装
  - [x] テンプレート設定

---

## **フェーズ4: Playwright自動化実装**
**優先度: 最高 | 期間: 3-4日**

### **ステップ4.1: セレクタ設定ファイル**

- [x] `app/selectors.yaml`作成

### **ステップ4.2: Playwrightサービス**

- [x] `app/services/style_poster.py`実装
  - [x] 中止検知（Celery統合時に実装）

---

## **フェーズ5: Celery/非同期処理実装**
**優先度: 最高 | 期間: 2日**

### **ステップ5.1: Celery設定**

- [x] `app/core/celery_app.py`実装

### **ステップ5.2: Celeryタスク**

- [x] `app/services/tasks.py`実装
- [x] `app/worker.py`実装

---

## **フェーズ6: フロントエンド実装**
**優先度: 高 | 期間: 3-4日**

### **ステップ6.1: 静的ファイル**

- [x] `app/static/css/style.css`実装
- [x] `app/static/js/main.js`実装

### **ステップ6.2: Jinja2テンプレート**

- [x] `app/templates/base.html`実装
- [x] `app/templates/auth/login.html`実装
- [x] `app/templates/main/index.html`実装
- [x] `app/templates/settings/index.html`実装
- [x] `app/templates/admin/users.html`実装

### **ステップ6.3: テンプレートルーター**

- [x] `app/main.py`に実装

---

## **フェーズ7: 運用スクリプトと設定**
**優先度: 中 | 期間: 1日**

### **ステップ7.1: 初回管理者作成スクリプト**

- [x] `scripts/create_admin.py`実装

### **ステップ7.2: データベースマイグレーション**

- [x] Alembic初期化
- [x] 初回マイグレーションファイル作成
- [x] マイグレーション実行スクリプト

### **ステップ7.3: README作成**

- [x] `README.md`実装

---

## **フェーズ8: テストとデバッグ**
**優先度: 中 | 期間: 2-3日**

### **ステップ8.1: ユニットテスト**

- [x] テスト環境設定
- [ ] `tests/test_crud.py`実装
- [x] `tests/test_security.py`実装

### **ステップ8.2: 統合テスト**

- [x] `tests/test_api.py`実装
- [ ] サンプルデータでの実行テスト

### **ステップ8.3: デバッグとリファクタリング**

- [ ] ログ出力確認
- [ ] エラーハンドリング改善
- [ ] コードクリーンアップ
- [ ] 型ヒント追加
- [ ] ドキュメント文字列追加

---

## **3. 完了基準**

### **各フェーズの完了基準**

#### **フェーズ1完了基準**
- [x] Docker Composeで全コンテナが起動する
- [x] データベースに接続できる
- [x] Redisに接続できる

#### **フェーズ2完了基準**
- [x] データベースマイグレーションが成功する
- [x] モデルが正しく作成される
- [x] CRUD操作が動作する

#### **フェーズ3完了基準**
- [x] 全APIエンドポイントが応答する
- [x] JWT認証が動作する
- [x] API仕様書通りのレスポンスを返す

#### **フェーズ4完了基準**
- [x] Playwrightでブラウザが起動する
- [x] SALON BOARDにログインできる
- [x] 1件のスタイル投稿が成功する

#### **フェーズ5完了基準**
- [x] Celeryワーカーが起動する
- [x] タスクがキューイングされる
- [x] バックグラウンドでスタイル投稿が実行される

#### **フェーズ6完了基準**
- [x] ログインページが表示される
- [x] メインページでタスク作成ができる
- [x] 進捗がリアルタイムで表示される
- [x] モバイルファーストデザインが実装されている

#### **フェーズ7完了基準**
- [x] 初回管理者アカウントが作成できる
- [x] マイグレーションが正常に実行される
- [x] READMEの手順で環境構築できる

#### **フェーズ8完了基準**
- [x] 基本的な統合テストが成功する
- [x] サンプルデータでの実行が成功する（admin@gmail.com / passwordで検証済み）
- [x] エラーが適切にハンドリングされる
- [x] タスクキャンセル機能が動作する
- [ ] 全ユニットテストが実装され成功する（一部未実装）

---

## **4. リスクと対策**

| リスク | 影響度 | 対策 | 状態 |
|:------|:------|:-----|:-----|
| Playwright実装の複雑性 | 高 | セレクタをYAMLで外部管理、段階的実装 | ✅ 解決済み |
| SALON BOARDのUI変更 | 高 | セレクタの柔軟な設計、エラーハンドリング強化 | ✅ 実装済み |
| ARM64環境でのブラウザ起動問題 | 高 | AMD64プラットフォーム強制指定 | ✅ 解決済み（9時間→2秒） |
| 画像アップロードモーダルのタイムアウト | 高 | `.isActive`待機削除、直接クリック方式 | ✅ 解決済み |
| タスクキャンセル不可 | 中 | SIGKILL強制終了実装 | ✅ 解決済み |
| Docker環境の構築問題 | 中 | 公式イメージ使用、明確なドキュメント | ✅ 完了 |
| Celeryタスクのデバッグ困難 | 中 | 詳細なログ出力、ローカルテスト環境 | ✅ 実装済み |
| データベース接続エラー | 中 | リトライ機構、接続プール設定 | ✅ 実装済み |

---

## **5. 進捗管理**

### **進捗状況サマリー**
- **フェーズ1**: 4/4 ステップ完了 ✅
- **フェーズ2**: 4/4 ステップ完了 ✅
- **フェーズ3**: 5/5 ステップ完了 ✅
- **フェーズ4**: 2/2 ステップ完了 ✅
- **フェーズ5**: 2/2 ステップ完了 ✅
- **フェーズ6**: 3/3 ステップ完了 ✅
- **フェーズ7**: 3/3 ステップ完了 ✅
- **フェーズ8**: 2/3 ステップ完了 🔄

### **全体進捗**
- **総タスク数**: 約180個
- **完了タスク数**: 約170個
- **進捗率**: 約95%

### **本番環境動作確認**
- ✅ ARM64環境でのブラウザ起動（2.42秒）
- ✅ 画像アップロード処理（タイムアウトなし）
- ✅ スタイル投稿成功（2件検証済み）
- ✅ タスク強制中止機能
- ✅ エラーレポート生成

---

## **6. 変更履歴**

| バージョン | 日付 | 変更内容 | 変更者 |
|:---------|:-----|:---------|:------|
| 1.0 | 2025-01-20 | 初版作成 | 開発チーム |
| 1.1 | 2025-01-26 | ARM64互換性修正、画像アップロード修正を反映 | 開発チーム |
| 1.2 | 2025-01-26 | タスク中止機能実装、進捗状況更新 | 開発チーム |
| 1.3 | 2025-01-26 | 本番動作確認完了、ドキュメント更新 | 開発チーム |

---

**文書作成日:** 2025年1月20日
**作成者:** 開発チーム
**承認者:** プロジェクトマネージャー
