{% extends "base.html" %}

{% block title %}タスク実行 - SALON BOARD Style Poster{% endblock %}

{% block content %}
<div class="card">
    <h2 class="card-header">スタイル投稿タスク</h2>

    <!-- タスク未実行時のフォーム -->
    <div id="task-form-section" class="hidden">
        <form id="task-form">
            <div class="form-group">
                <label for="setting_id" class="form-label">SALON BOARD設定</label>
                <select id="setting_id" name="setting_id" class="form-select" required>
                    <option value="">設定を選択してください</option>
                </select>
                <span class="form-hint">
                    設定がない場合は「設定」ページから追加してください
                </span>
            </div>

            <div class="form-group">
                <label for="style_data_file" class="form-label">スタイル情報ファイル</label>
                <input
                    type="file"
                    id="style_data_file"
                    name="style_data_file"
                    class="form-input form-file"
                    accept=".csv,.xlsx"
                    required
                >
                <span class="form-hint">
                    CSV または Excel ファイル（.csv, .xlsx）を選択してください
                </span>
            </div>

            <div class="form-group">
                <label for="image_files" class="form-label">画像ファイル</label>
                <input
                    type="file"
                    id="image_files"
                    name="image_files"
                    class="form-input form-file"
                    accept="image/*"
                    multiple
                    required
                >
                <span class="form-hint">
                    スタイル情報ファイルで指定した画像をすべて選択してください
                </span>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary">
                    タスクを開始
                </button>
            </div>
        </form>
    </div>

    <!-- タスク実行中の進捗表示 -->
    <div id="task-progress-section" class="hidden">
        <div class="progress-container">
            <div class="progress-bar-wrapper">
                <div id="progress-bar" class="progress-bar" style="width: 0%">
                    <span id="progress-text">0%</span>
                </div>
            </div>
            <div class="progress-info">
                <span id="progress-items">0 / 0 件完了</span>
                <span id="progress-status">処理中...</span>
            </div>
        </div>

        <!-- エラーサマリー（処理中） -->
        <div id="error-summary-progress" class="error-summary hidden">
            <div class="error-summary-header">
                <span class="error-summary-icon">⚠️</span>
                <span class="error-summary-text">エラー発生中: <span id="error-count-progress" class="error-count">0</span>件</span>
            </div>
        </div>

        <div class="mt-2">
            <p class="text-muted">
                タスクID: <span id="task-id" class="text-primary"></span>
            </p>
            <p class="text-muted">
                開始時刻: <span id="task-created-at"></span>
            </p>
        </div>

        <div class="btn-group mt-2">
            <button id="cancel-task-btn" class="btn btn-danger">
                タスクを中止
            </button>
        </div>
    </div>

    <!-- タスク完了時の結果表示 -->
    <div id="task-result-section" class="hidden">
        <div id="success-message" class="alert alert-success hidden">
            タスクが完了しました！
        </div>

        <div id="failure-message" class="alert alert-danger hidden">
            タスクがエラーにより中断されました
        </div>

        <div id="error-report-section" class="hidden">
            <h3 class="mt-2 mb-1">エラーレポート</h3>

            <!-- エラーサマリー（完了時） -->
            <div class="error-summary mb-2">
                <div class="error-summary-header">
                    <span class="error-summary-icon">⚠️</span>
                    <span class="error-summary-text">合計 <span id="error-count-result" class="error-count">0</span>件のエラー</span>
                </div>
            </div>

            <div id="error-list" class="error-list"></div>
        </div>

        <div class="btn-group mt-2">
            <button id="new-task-btn" class="btn btn-primary">
                新しいタスクを開始
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let pollingInterval = null;
    let currentUser = null;
    let lastErrorCount = 0;
    let notificationPermission = 'default';

    // ページロード時の初期化
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // ユーザー情報取得
            currentUser = await apiCall('/api/v1/auth/me');

            // ブラウザ通知の許可を要求
            await requestNotificationPermission();

            // SALON BOARD設定を読み込み
            await loadSettings();

            // タスクステータスを確認
            await checkTaskStatus();
        } catch (error) {
            console.error('Initialization error:', error);
            showAlert(error.message, 'danger');
        }
    });

    // ブラウザ通知許可を要求
    async function requestNotificationPermission() {
        if ('Notification' in window) {
            notificationPermission = await Notification.requestPermission();
            console.log('Notification permission:', notificationPermission);
        }
    }

    // ブラウザ通知を送信
    function sendNotification(title, body, options = {}) {
        if (notificationPermission === 'granted') {
            new Notification(title, {
                body: body,
                icon: '/static/favicon.ico',
                badge: '/static/favicon.ico',
                ...options
            });
        }
    }

    // SALON BOARD設定読み込み
    async function loadSettings() {
        try {
            const data = await apiCall('/api/v1/sb-settings/');
            const settings = data.settings || [];
            const select = document.getElementById('setting_id');

            // 既存のオプションをクリア（最初のoption以外）
            while (select.options.length > 1) {
                select.remove(1);
            }

            if (settings.length === 0) {
                showAlert('SALON BOARD設定が登録されていません。設定ページから登録してください。', 'warning');
            }

            settings.forEach(setting => {
                const option = document.createElement('option');
                option.value = setting.id;
                option.textContent = setting.setting_name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Failed to load settings:', error);
        }
    }

    // タスクステータス確認
    async function checkTaskStatus() {
        try {
            const status = await apiCall('/api/v1/tasks/status');

            if (status.status === 'PROCESSING' || status.status === 'CANCELLING') {
                // 実行中
                showProgressSection(status);
                startPolling();
            } else if (status.status === 'SUCCESS' || status.status === 'FAILURE') {
                // 完了
                await showResultSection(status);
            }
        } catch (error) {
            // タスクが存在しない場合
            showFormSection();
        }
    }

    // フォームセクション表示
    function showFormSection() {
        document.getElementById('task-form-section').classList.remove('hidden');
        document.getElementById('task-progress-section').classList.add('hidden');
        document.getElementById('task-result-section').classList.add('hidden');
    }

    // 進捗セクション表示
    function showProgressSection(status) {
        document.getElementById('task-form-section').classList.add('hidden');
        document.getElementById('task-progress-section').classList.remove('hidden');
        document.getElementById('task-result-section').classList.add('hidden');

        updateProgress(status);
    }

    // 結果セクション表示
    async function showResultSection(status) {
        document.getElementById('task-form-section').classList.add('hidden');
        document.getElementById('task-progress-section').classList.add('hidden');
        document.getElementById('task-result-section').classList.remove('hidden');

        if (status.status === 'SUCCESS') {
            document.getElementById('success-message').classList.remove('hidden');
            document.getElementById('failure-message').classList.add('hidden');
        } else {
            document.getElementById('success-message').classList.add('hidden');
            document.getElementById('failure-message').classList.remove('hidden');
        }

        // エラーレポート取得
        if (status.has_errors) {
            await loadErrorReport();
        } else {
            document.getElementById('error-report-section').classList.add('hidden');
        }
    }

    // 進捗更新
    function updateProgress(status) {
        const progress = status.progress;
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressItems = document.getElementById('progress-items');
        const progressStatus = document.getElementById('progress-status');
        const taskId = document.getElementById('task-id');
        const taskCreatedAt = document.getElementById('task-created-at');

        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${progress}%`;
        progressItems.textContent = `${status.completed_items} / ${status.total_items} 件完了`;
        progressStatus.textContent = status.status === 'CANCELLING' ? '中止中...' : '処理中...';
        taskId.textContent = status.task_id;
        taskCreatedAt.textContent = new Date(status.created_at).toLocaleString('ja-JP');

        // エラーサマリー表示（処理中）
        const errorSummaryProgress = document.getElementById('error-summary-progress');
        const errorCountProgress = document.getElementById('error-count-progress');

        if (status.error_count > 0) {
            errorSummaryProgress.classList.remove('hidden');
            errorCountProgress.textContent = status.error_count;

            // 新しいエラーが発生した場合は通知
            if (status.error_count > lastErrorCount) {
                const newErrors = status.error_count - lastErrorCount;
                sendNotification(
                    'エラー発生',
                    `${newErrors}件の新しいエラーが発生しました（合計${status.error_count}件）`,
                    { tag: 'task-error' }
                );
            }
            lastErrorCount = status.error_count;
        } else {
            errorSummaryProgress.classList.add('hidden');
        }
    }

    // ポーリング開始
    function startPolling() {
        if (pollingInterval) return;

        pollingInterval = setInterval(async () => {
            try {
                const status = await apiCall('/api/v1/tasks/status');

                if (status.status === 'PROCESSING' || status.status === 'CANCELLING') {
                    updateProgress(status);
                } else {
                    // 完了
                    stopPolling();
                    lastErrorCount = 0; // リセット

                    // 完了通知
                    if (status.status === 'SUCCESS') {
                        sendNotification(
                            'タスク完了',
                            status.has_errors
                                ? `タスクが完了しました（エラー: ${status.error_count}件）`
                                : 'タスクが完了しました',
                            { tag: 'task-complete' }
                        );
                    } else {
                        sendNotification(
                            'タスク失敗',
                            'タスクがエラーにより中断されました',
                            { tag: 'task-failed' }
                        );
                    }

                    await showResultSection(status);
                }
            } catch (error) {
                console.error('Polling error:', error);
                stopPolling();
            }
        }, 2000); // 2秒ごと
    }

    // ポーリング停止
    function stopPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
    }

    // エラーレポート読み込み
    async function loadErrorReport() {
        try {
            const report = await apiCall('/api/v1/tasks/error-report');
            const errorList = document.getElementById('error-list');
            const errorSection = document.getElementById('error-report-section');
            const errorCountResult = document.getElementById('error-count-result');

            errorList.innerHTML = '';
            errorCountResult.textContent = report.total_errors;

            report.errors.forEach((error, index) => {
                const errorItem = document.createElement('div');
                errorItem.className = 'error-item';

                // デバッグ: エラー情報をコンソールに出力
                console.log(`Error ${index + 1}:`, error);
                console.log(`Screenshot URL:`, error.screenshot_url);

                // スクリーンショット部分のHTML
                const screenshotHtml = error.screenshot_url ? `
                    <div class="error-screenshot">
                        <strong>スクリーンショット:</strong>
                        <div class="screenshot-thumbnail-container">
                            <img
                                src="${error.screenshot_url}"
                                alt="Error screenshot"
                                class="screenshot-thumbnail"
                                onclick="openScreenshotModal('${error.screenshot_url}')"
                            >
                            <div class="screenshot-overlay">クリックで拡大</div>
                        </div>
                    </div>
                ` : '';

                errorItem.innerHTML = `
                    <div class="error-item-header">
                        <span class="error-number">エラー ${index + 1}</span>
                        <span class="error-row">行 ${error.row_number}</span>
                        <span class="error-style-name">${error.style_name}</span>
                    </div>
                    <div class="error-item-details">
                        <div class="error-field">
                            <strong>項目:</strong> ${error.field}
                        </div>
                        <div class="error-reason">
                            <strong>理由:</strong> ${error.reason}
                        </div>
                        ${screenshotHtml}
                    </div>
                `;
                errorList.appendChild(errorItem);
            });

            errorSection.classList.remove('hidden');
        } catch (error) {
            console.error('Failed to load error report:', error);
        }
    }

    // スクリーンショットモーダルを開く
    function openScreenshotModal(imageUrl) {
        // モーダル要素を作成
        const modal = document.createElement('div');
        modal.className = 'screenshot-modal';
        modal.innerHTML = `
            <div class="screenshot-modal-content">
                <span class="screenshot-modal-close">&times;</span>
                <img src="${imageUrl}" alt="Screenshot" class="screenshot-modal-image">
            </div>
        `;

        document.body.appendChild(modal);

        // 閉じるボタン
        const closeBtn = modal.querySelector('.screenshot-modal-close');
        closeBtn.onclick = () => {
            document.body.removeChild(modal);
        };

        // モーダル背景クリックで閉じる
        modal.onclick = (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        };

        // ESCキーで閉じる
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                document.body.removeChild(modal);
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }

    // タスクフォーム送信
    document.getElementById('task-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);

        showLoading();

        try {
            const result = await apiCallFormData('/api/v1/tasks/style-post', formData);

            hideLoading();
            showAlert('タスクを開始しました', 'success');

            // 進捗セクションに切り替え
            await checkTaskStatus();
        } catch (error) {
            hideLoading();
            showAlert(error.message, 'danger');
        }
    });

    // タスク中止ボタン
    document.getElementById('cancel-task-btn').addEventListener('click', async () => {
        if (!confirm('本当にタスクを即座に中止しますか？\n実行中の処理は強制終了されます。')) {
            return;
        }

        try {
            await apiCall('/api/v1/tasks/cancel', { method: 'POST' });
            showAlert('タスクを強制終了しました', 'success');
            // ページをリロードして状態を更新
            setTimeout(() => location.reload(), 1000);
        } catch (error) {
            showAlert(error.message, 'danger');
        }
    });

    // 新しいタスク開始ボタン
    document.getElementById('new-task-btn').addEventListener('click', async () => {
        try {
            await apiCall('/api/v1/tasks/finished-task', { method: 'DELETE' });
            showFormSection();
            // フォームをリセット
            document.getElementById('task-form').reset();
        } catch (error) {
            showAlert(error.message, 'danger');
        }
    });
</script>
{% endblock %}
